name: ArgoCD Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  terraform:
    name: Apply Terraform
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.6

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Deploy to EKS with ArgoCD
      run: |
        aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.CLUSTER_NAME }}
        kubectl create namespace argocd
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'
        
        echo "Waiting for ArgoCD deployments to be ready..."
        kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
        kubectl wait --for=condition=available deployment/argocd-repo-server -n argocd --timeout=300s
        kubectl wait --for=condition=available deployment/argocd-redis -n argocd --timeout=300s
        kubectl wait --for=condition=available deployment/argocd-dex-server -n argocd --timeout=300s
        
        echo "Waiting for ArgoCD application controller to be ready..."
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=300s
        
        echo "Waiting for initial admin secret to be created..."
        for i in {1..24}; do
          if kubectl get secret argocd-initial-admin-secret -n argocd &> /dev/null; then
            echo "Secret found!"
            break
          fi
          echo "Attempt $i/24: Secret not found yet, waiting 5 seconds..."
          sleep 5
        done
        
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d